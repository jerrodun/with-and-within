var BsubWidget=function(){function v(){this.attrs={purchaseOptionOneTime:"data-bsub-purchase-option-one-time",sellingPlanGroupId:"data-bsub-selling-plan-group-id",sellingPlanIdInput:"data-bsub-selling-plan-id-input",widget:"data-bsub-widget",sellingPlanOptionsContainer:"data-bsub-selling-plan-options-container",sellingPlanOption:"data-bsub-selling-plan-option",sellingPlansContainer:"data-bsub-selling-plans-container",sellingPlanGroup:"data-bsub-selling-plan-group",sellingPlanGroupInput:"data-bsub-selling-plan-group-input",sellingPlan:"data-bsub-selling-plan",sellingPlanInput:"data-bsub-selling-plan-input",productJson:"data-bsub-product-json",groupDiscountSummary:"data-bsub-group-discount-summary",perDeliveryPrice:"data-bsub-per-delivery-price",cartPopupDetails:"data-bsub-cart-popup-details",cartPageDetails:"data-bsub-cart-page-details",moneyFormat:"data-bsub-money-format",pageTemplate:"data-bsub-page-template"},this.selectors={productForm:'form[action="/cart/add"]',variantIdInput:'[name="id"]',variantSelector:["#shappify-variant-id",".single-option-selector","select[name=id]","input[name=id]"]},Object.entries(this.attrs).forEach(function([e,t]){this.selectors[e]=`[${t}]`}.bind(this)),this.classes={hidden:"bsub__hidden"},this.products={},this.variants={},this.sellingPlanGroups={},this.pageTemplate=""}return v.prototype=Object.assign({},v.prototype,{init:function(){if(console.debug("BSUB: Initializing widgets..."),!document.querySelector(this.selectors.widget)){console.debug("BSUB: No widgets detected, skipping initialization.");return}this._parsePageTemplate(),this._parseProductJson(),this._addVariantChangeListener();var e=document.querySelectorAll(this.selectors.widget);e.forEach(function(t){this._renderPrices(t),this._renderGroupDiscountSummary(t)}.bind(this)),window.addEventListener("pageshow",function(){this.syncAllVisuallySelected()}.bind(this)),console.debug("BSUB: Successfully initialized widgets.")},syncAllVisuallySelected:function(){var e=document.querySelectorAll(this.selectors.widget);e.forEach(this._syncVisuallySelected.bind(this))},_syncVisuallySelected:function(e){var t=e.querySelector(`${this.selectors.sellingPlanGroupInput}:checked`);t.dispatchEvent(new Event("change"))},_addVariantChangeListener:function(){var e=document.querySelectorAll(this.selectors.variantSelector.join());e.forEach(function(t){t&&t.addEventListener("change",function(n){var i=n.target.closest(this.selectors.productForm),r=i.querySelector(this.selectors.widget);setTimeout(function(){this._renderPrices(r),this._renderGroupDiscountSummary(r)}.bind(this),100)}.bind(this))}.bind(this))},_parsePageTemplate:function(){var e=document.querySelector(this.selectors.pageTemplate);e!==null&&(this.pageTemplate=e.value)},_parseProductJson:function(){var e=document.querySelectorAll(this.selectors.productJson);e.forEach(function(t){var n=JSON.parse(t.innerHTML);this.products[t.dataset.bsubProductId]=n,n.selling_plan_groups.forEach(function(i){this.sellingPlanGroups[i.id]=i}.bind(this)),n.variants.forEach(function(i){this.variants[i.id]=i}.bind(this))}.bind(this))},renderAllPrices:function(){var e=document.querySelectorAll(this.selectors.widget);e.forEach(this._renderPrices.bind(this))},_renderPrices:function(e){typeof e>"u"&&(e=document.querySelector(this.selectors.widget));var t=e.querySelectorAll(this.selectors.sellingPlan),n=this._getVariantId(e);n&&t.forEach(function(i){var r=i.dataset.bsubSellingPlanId,s=this._getSellingPlanAllocation(n,r),o=i.querySelector(this.selectors.perDeliveryPrice),a=s.per_delivery_price,u=this._formatPrice(a);o.innerHTML=u}.bind(this))},renderAllGroupDiscountSummary:function(){var e=document.querySelectorAll(this.selectors.widget);e.forEach(this._renderGroupDiscountSummary.bind(this))},_renderGroupDiscountSummary:function(e){var t=e.querySelector(this.selectors.productJson),n=t.dataset.bsubProductId,i=e.querySelectorAll(this.selectors.sellingPlanGroup);i.forEach(function(r){var s=r.dataset.bsubSellingPlanGroupId,o=this.products[n],a=o.selling_plan_groups.find(function(l){return l.id===s}),u=a.selling_plans.map(function(l){return l.price_adjustments.length===0?{value:0,type:""}:{value:l.price_adjustments[0].value,type:l.price_adjustments[0].value_type}}),d=u.reduce(function(l,h){return l.value>h.value?l:h});if(d.value!==0){var p=u.some(function(l){return l.value!==d.value}),g=r.querySelector(this.selectors.groupDiscountSummary),c="(Save";switch(p&&(c+=" up to "),d.type){case"fixed_amount":c+=this._formatPrice(d.value);break;case"percentage":default:c+=` ${d.value}%`}c+=")",g.innerHTML=c}}.bind(this))},handleSellingPlanGroupChange:function(e){var t=e.target,n=t.value,i=t.closest(this.selectors.widget),r=i.querySelectorAll(this.selectors.sellingPlansContainer);if(r.forEach(function(o){var a=o.dataset.bsubSellingPlanGroupId;a===n&&t.checked?o.classList.remove(this.classes.hidden):o.classList.add(this.classes.hidden)}.bind(this)),n==="once"){this._setSellingPlanIdInput(i,"");return}var s=this._getActiveSellingPlanId(i,n);this._setSellingPlanIdInput(i,s)},handleSellingPlanChange:function(e){var t=e.target,n=t.closest(this.selectors.widget);this._setSellingPlanIdInput(n,t.value)},handleSellingPlanOptionChange:function(e){var t=e.target.closest(this.selectors.widget),n=e.target.dataset.bsubSellingPlanGroupId,i=this._getSellingPlanOptions(t,n),r=this._getSellingPlanFromOptions(n,i);this._setSellingPlanIdInput(r.id)},_setSellingPlanIdInput:function(e,t){var n=e.querySelector(this.selectors.sellingPlanIdInput),i=this._getVariantId(e);n.value=t,/.*(product).*/.test(this.pageTemplate)&&this._updateHistoryState(i,t)},_getSellingPlanGroup:function(e){if(!this.sellingPlanGroups[e]){console.error("BSUB: Selling plan group data not found.");return}return this.sellingPlanGroups[e]},_getSellingPlanOptions:function(e,t){var n=e.querySelectorAll(`${this.selectors.sellingPlanOption}[${this.attrs.sellingPlanGroupId}="${t}"]:checked`),i=[];return n.forEach(function(r){i.push({index:r.dataset.bsubOptionIndex,value:r.value})}),i},_getSellingPlanFromOptions:function(e,t){var n=this._getSellingPlanGroup(e).selling_plans,i=n.find(function(r){return t.every(function(s){return r.options[s.index].value===s.value})});return i},_getVariantId:function(e){var t=e.closest(this.selectors.productForm);if(!t)return console.error("BSUB: Could not find product form."),null;var n=t.querySelector(this.selectors.variantIdInput);return n.value},_getActiveSellingPlanId:function(e,t){var n=e.querySelector(`input[name=bsub-selling-plan-${t}]:checked`);return n||console.error(`BSUB: Could not find active plan ID for group ${t}.`),n.value},_updateHistoryState:function(e,t){if(!(!history.replaceState||!e)){var n=window.location.protocol+"//"+window.location.host+window.location.pathname+"?";t&&(n+="selling_plan="+t+"&"),n+="variant="+e,window.history.replaceState({path:n},"",n)}},_getSellingPlanAllocation(e,t){var n=this.variants[e];return n?n.selling_plan_allocations.find(function(i){return`${i.selling_plan_id}`===t}):(console.error(`BSUB: Could not find variant ID ${e}`),null)},_formatPrice(e,t){var n=document.querySelector(this.selectors.moneyFormat),i=n?n.getAttribute("data-bsub-money-format"):null;typeof e=="string"&&(e=e.replace(".",""));var r="",s=/\{\{\s*(\w+)\s*\}\}/,o=t||i||theme.moneyFormat||theme.strings.moneyFormat||Shopify.money_format||"$ {% raw %}{{ amount }}{% endraw %}";function a(u,d,p,g){if(p=p||",",g=g||".",isNaN(u)||u===null)return 0;u=(u/100).toFixed(d);var c=u.split("."),l=c[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+p),h=c[1]?g+c[1]:"";return l+h}switch(o.match(s)[1]){case"amount":r=a(e,2);break;case"amount_no_decimals":r=a(e,0);break;case"amount_with_comma_separator":r=a(e,2,".",",");break;case"amount_no_decimals_with_comma_separator":r=a(e,0,".",",");break;case"amount_no_decimals_with_space_separator":r=a(e,0," ");break;case"amount_with_apostrophe_separator":r=a(e,2,"'");break}return o.replace(s,r)}}),v}();document.addEventListener("DOMContentLoaded",function(){window.BOLD=window.BOLD||{},window.BOLD.BsubWidget=new BsubWidget,window.BOLD.BsubWidget.init()});
